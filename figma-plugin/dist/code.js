function y(t){const e={id:"variant-control",title:"Control",trafficPercent:100,status:"Running",figmaNodeId:void 0};return{steps:[{id:"step-1",title:t,description:"",kpi:"",status:"Running",figmaNodeId:void 0,variantIds:[e.id]}],variants:[e],edges:[]}}function S(t,e,n){if(!t.steps.find(o=>o.id===e))throw new Error("Step not found");const r=`variant-${Date.now()}`,s={id:r,title:n,trafficPercent:0,status:"Backlog",figmaNodeId:void 0};return{...t,steps:t.steps.map(o=>o.id===e?{...o,variantIds:[...o.variantIds,r]}:o),variants:[...t.variants,s]}}function N(t,e,n){const a=`step-${Date.now()}`,r={id:a,title:n,description:"",kpi:"",status:"Backlog",figmaNodeId:void 0,variantIds:[]},s={id:`edge-${Date.now()}`,fromVariantId:e,toStepId:a,figmaConnectorId:void 0};return{...t,steps:[...t.steps,r],edges:[...t.edges,s]}}function T(t,e,n){if(t.edges.some(r=>r.fromVariantId===e&&r.toStepId===n))return t;const a={id:`edge-${Date.now()}`,fromVariantId:e,toStepId:n,figmaConnectorId:void 0};return{...t,edges:[...t.edges,a]}}function h(t,e){return{...t,variants:t.variants.map(n=>n.id===e?{...n,winner:!0,status:"Winner"}:{...n,winner:!1})}}function v(t,e){const n=t.steps.find(r=>r.id===e);if(!n)throw new Error("Step not found");const a=t.variants.find(r=>r.winner&&n.variantIds.includes(r.id))?.id;if(!a)throw new Error("No winner variant for this step");return{...t,variants:t.variants.map(r=>r.id===a?{...r,launched:!0,status:"Launched"}:r)}}function _(t){const s=t.steps,o={};return s.forEach((d,c)=>{const p=40+c*300,m=80;o[d.id]={x:p,y:m};let f=m;const l=d.variantIds.find(g=>{const u=t.variants.find(I=>I.id===g);return u&&u.title.toLowerCase()==="control"});l&&(o[l]={x:p+0,y:f},f+=120),d.variantIds.forEach(g=>{g!==l&&(o[g]={x:p+0,y:f},f+=120)})}),o}function A(t){let e;t.figmaNodeId&&(e=figma.getNodeById(t.figmaNodeId)),e||(e=figma.createFrame(),e.resize(180,80),e.fills=[{type:"SOLID",color:{r:.95,g:.98,b:1}}],e.cornerRadius=12,e.strokes=[{type:"SOLID",color:{r:.2,g:.4,b:.7}}],e.strokeWeight=2,e.name=t.title);let n=e.children.find(a=>a.type==="TEXT"&&a.name==="StepTitle");return n||(n=figma.createText(),n.name="StepTitle",e.appendChild(n)),n.characters=t.title,n.fontSize=18,n.fontName={family:"Inter",style:"Bold"},n.x=16,n.y=16,e}function E(t){let e;t.figmaNodeId&&(e=figma.getNodeById(t.figmaNodeId)),e||(e=figma.createFrame(),e.resize(160,60),e.fills=[{type:"SOLID",color:{r:.98,g:.98,b:.99}}],e.cornerRadius=8,e.strokes=[{type:"SOLID",color:{r:.5,g:.5,b:.7}}],e.strokeWeight=1,e.name=t.title);let n=e.children.find(a=>a.type==="TEXT"&&a.name==="VariantTitle");return n||(n=figma.createText(),n.name="VariantTitle",e.appendChild(n)),n.characters=t.title,n.fontSize=16,n.fontName={family:"Inter",style:"Bold"},n.x=12,n.y=12,e}function O(t,e,n){let a;t.figmaConnectorId&&(a=figma.getNodeById(t.figmaConnectorId)),a||(a=figma.createVector(),a.name="Connector");const r=e.x+e.width,s=e.y+e.height/2,o=n.x,d=n.y+n.height/2;return a.vectorPaths=[{data:`M ${r} ${s} L ${o} ${d}`,windingRule:"NONE"}],a.strokeWeight=3,a.strokes=[{type:"SOLID",color:{r:.2,g:.4,b:.7}}],a}let i=null;figma.showUI(__html__,{width:400,height:600});figma.ui.onmessage=async t=>{switch(t.type){case"CREATE_EXPERIMENT":{i=y(t.name),figma.root.setPluginData("experimentFlow",JSON.stringify(i));break}case"ADD_VARIANT":{if(!i)return;i=S(i,t.stepId,t.variantTitle),figma.root.setPluginData("experimentFlow",JSON.stringify(i));break}case"ADD_STEP":{if(!i)return;i=N(i,t.sourceVariantId,t.stepTitle),figma.root.setPluginData("experimentFlow",JSON.stringify(i));break}case"CONNECT_NODES":{if(!i)return;i=T(i,t.sourceVariantId,t.targetStepId),figma.root.setPluginData("experimentFlow",JSON.stringify(i));break}case"MARK_WINNER":{if(!i)return;i=h(i,t.variantId),figma.root.setPluginData("experimentFlow",JSON.stringify(i));break}case"LAUNCH_WINNER":{if(!i)return;i=v(i,t.stepId),figma.root.setPluginData("experimentFlow",JSON.stringify(i));break}case"AUTO_LAYOUT":{if(!i)return;const e=_(i);for(const n of i.steps){const a=A(n),r=e[n.id];r&&(a.x=r.x,a.y=r.y);for(const s of n.variantIds){const o=i.variants.find(d=>d.id===s);if(o){const d=E(o),c=e[o.id];c&&(d.x=c.x,d.y=c.y),a.appendChild(d)}}figma.currentPage.appendChild(a)}for(const n of i.edges){const a=i.variants.find(s=>s.id===n.fromVariantId),r=i.steps.find(s=>s.id===n.toStepId);if(a&&r){const s=figma.getNodeById(a.figmaNodeId),o=figma.getNodeById(r.figmaNodeId),d=O(n,s,o);figma.currentPage.appendChild(d)}}break}case"EXPORT_JSON":{if(!i)return;figma.ui.postMessage({type:"EXPORT_JSON",data:JSON.stringify(i,null,2)});break}case"IMPORT_JSON":{if(!t.data)return;i=JSON.parse(t.data),figma.root.setPluginData("experimentFlow",JSON.stringify(i));break}default:figma.notify("Unknown message type")}};
